<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>__AVATAR_NAME__ Â· Live session</title>

  <!-- LiveKit UMD -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/livekit-client/2.15.7/livekit-client.umd.min.js"></script>

  <style>
    html,body{margin:0;padding:0;background:#000;font-family:system-ui}
    .frame{position:relative;height:540px;border-radius:18px;overflow:hidden}
    video{width:100%;height:100%;object-fit:cover}
    .overlay{position:absolute;left:10px;right:10px;bottom:10px;
      background:rgba(0,0,0,.6);color:#fff;padding:10px;border-radius:12px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pill{padding:4px 10px;border-radius:999px;background:rgba(255,255,255,.15)}
    .ok{color:#a4ffce}.bad{color:#ff6b6b}.warn{color:#ffd166}
    .log{margin-top:8px;max-height:120px;overflow:auto;font-family:monospace;font-size:11px}
    button{background:rgba(255,255,255,.2);border:0;color:#fff;padding:6px 10px;border-radius:8px}
  </style>
</head>

<body>
<div class="frame">
  <video id="avatarVideo" autoplay playsinline></video>

  <div class="overlay">
    <div class="row">
      <span id="sdk" class="pill">SDK</span>
      <span id="room" class="pill">Room</span>
      <span id="tracks" class="pill">Tracks</span>
      <button id="reconnect">Reconnect</button>
      <button id="speak">Speak(text)</button>
    </div>
    <div class="log" id="log"></div>
  </div>
</div>

<script>
const LIVEKIT_URL="__LIVEKIT_URL__";
const LIVEKIT_TOKEN="__LIVEKIT_TOKEN__";
const PAYLOAD=__SPEAK_PAYLOAD_JSON__;

const logEl=document.getElementById("log");
const sdkP=document.getElementById("sdk");
const roomP=document.getElementById("room");
const tracksP=document.getElementById("tracks");
const videoEl=document.getElementById("avatarVideo");

function log(m){logEl.textContent+=`[${new Date().toLocaleTimeString()}] ${m}\n`;logEl.scrollTop=1e9;}
function pill(el,t,c){el.textContent=t;el.className=`pill ${c||""}`}

pill(sdkP,"SDK: loaded","ok");

const LK=window.LiveKitClient||window.LiveKit;
if(!LK){pill(sdkP,"SDK missing","bad");throw new Error("LiveKit missing");}

let room=null;
let localMicTrack=null;
let count=0;

async function connect(){
  try{
    pill(roomP,"connecting","warn");
    room=new LK.Room();

    room.on(LK.RoomEvent.TrackSubscribed,(track,pub,participant)=>{
      log(`TrackSubscribed ${track.kind} from ${participant.identity}`);
      if(track.kind==="video") track.attach(videoEl);
      if(track.kind==="audio"){
        const a=document.createElement("audio");
        a.autoplay=true;track.attach(a);
      }
      tracksP.textContent=`Tracks: ${++count}`;
    });

    await room.connect(LIVEKIT_URL,LIVEKIT_TOKEN);
    pill(roomP,"connected","ok");

    // ---- MICROPHONE ENABLED HERE ----
    localMicTrack=await LK.createLocalAudioTrack();
    await room.localParticipant.publishTrack(localMicTrack);
    log("Local microphone published");

  }catch(e){
    pill(roomP,"error","bad");
    log(e.message||e);
  }
}

async function speakText(){
  if(!room) return;
  const text=PAYLOAD?.text||"";
  const msg={event:"avatar.speak_text",data:{text}};
  await room.localParticipant.publishData(
    new TextEncoder().encode(JSON.stringify(msg)),
    {reliable:true}
  );
  log(`avatar.speak_text sent (${text.length} chars)`);
}

document.getElementById("reconnect").onclick=async()=>{
  try{room&&await room.disconnect()}catch{}
  await connect();
};
document.getElementById("speak").onclick=speakText;

connect();
</script>
</body>
</html>
